@page "/tickets"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@using BlazorApp1.Components.Ticket

<PageTitle>Tickets</PageTitle>

<div class="ticket-container">
    <!-- Sticky header group -->
    <div class="sticky-header-group">
        <!-- Search header -->
        <div class="search-header">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       placeholder="Search Ticket Number" 
                       @bind="searchTerm"
                       @bind:event="oninput" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="clear-btn" @onclick="ClearSearch">
                        <i class="bi bi-x"></i>
                    </button>
                }
            </div>
        </div>

        <!-- Filter by category with divider and dropdown -->
        <div class="filter-container">
            <div class="filter-wrap">
                <!-- Left side: My and All buttons -->
                <div class="primary-filters">
                    <button class="filter-chip @(showMyTickets ? "active" : "")" 
                            @onclick="() => FilterMyTickets(true)">
                        My
                        <span>@GetMyTicketsCount()</span>
                    </button>
                    <button class="filter-chip @(!showMyTickets && selectedCategory == null ? "active" : "")" 
                            @onclick="() => FilterMyTickets(false)">
                        All
                        <span>@GetAllTicketsCount()</span>
                    </button>
                </div>
                
                <!-- Vertical divider -->
                <div class="filter-divider"></div>
                
                <!-- Right side: Category dropdown for mobile -->
                <div class="category-dropdown">
                    <button class="filter-chip @(selectedCategory != null ? "active-filter" : "")" 
                            @onclick="@(selectedCategory != null 
                                ? EventCallback.Factory.Create(this, (Action)ClearCategoryFilter) 
                                : EventCallback.Factory.Create(this, (Action)ToggleCategoryDropdown))" 
                            @onclick:preventDefault="true" 
                            @onclick:stopPropagation="true">
                        @(selectedCategory ?? "Categories") 
                        @if (selectedCategory != null)
                        {
                            <div class="chevron">
                                <i class="bi bi-x-circle"></i>
                            </div>
                        }
                        else
                        {
                            <div class="chevron">
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            
                        }
                    </button>
                    
                    @if (showCategoryDropdown)
                    {
                        <div class="category-dropdown-menu" @onclick:stopPropagation="true">
                            <div class="dropdown-header">Filter by category</div>
                            <button class="dropdown-item @(selectedCategory == null ? "active" : "")" 
                                    @onclick="() => FilterByCategory(null)">
                                All Categories
                            </button>
                            @foreach (var category in GetUniqueCategories())
                            {
                                <button class="dropdown-item @(selectedCategory == category ? "active" : "")" 
                                        @onclick="() => FilterByCategory(category)">
                                    @category
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (tickets == null)
    {
        <!-- Skeleton loader for list items -->
        <div class="tickets-list">
            @for (int i = 0; i < 3; i++)
            {
                <div class="skeleton-ticket">
                    <div class="skeleton-line skeleton-id"></div>
                    <div class="skeleton-line skeleton-desc"></div>
                    <div class="skeleton-footer">
                        <div class="skeleton-line skeleton-ref"></div>
                        <div class="skeleton-line skeleton-status"></div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="tickets-list">
            @foreach (var ticket in FilteredAndSortedTickets)
            {
                <TicketComp Ticket="@ticket" OnTicketClick="NavigateToTicket" />
            }
            
            @if (FilteredAndSortedTickets.Count() == 0)
            {
                <div class="empty-state">
                    <i class="fas fa-ticket-alt empty-icon"></i>
                    <p>No tickets found matching your criteria</p>
                </div>
            }
        </div>
    }

    <!-- Create new ticket button -->
    <CreateTicketBtn />
</div>

@code {
    private TicketComp.TicketContainer[]? tickets;
    private string searchTerm = "";
    private string? selectedCategory = null;
    private bool showMyTickets = true; // Changed from false to true
    private bool showCategoryDropdown = false;
    
    protected override async Task OnInitializedAsync()
    {
        // Simulate asynchronous loading
        await Task.Delay(500);

        var startDate = DateTime.Now;
        var categories = new[] { "Drammen", "BÃ¦rum", "Kongsberg", "Ringerike", "Feilmeld", "Mikrobiologen", "Martina Hansen", "Prioritering" };
        tickets = Enumerable.Range(1, 10).Select(index => new TicketComp.TicketContainer
        {
            Date = startDate.AddDays(-index),
            Category = categories[Random.Shared.Next(categories.Length)],
            Header = $"Ticket {index}: {Lorem(4)}",
            ID = index,
            Details = Lorem(20),
            Status = Random.Shared.Next(3) // 0: New, 1: In Progress, 2: Resolved
        }).ToArray();
    }
    
    private string Lorem(int words)
    {
        var loremWords = "Lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua".Split(' ');
        return string.Join(" ", Enumerable.Range(0, words).Select(_ => loremWords[Random.Shared.Next(loremWords.Length)]));
    }

    private void ClearSearch()
    {
        searchTerm = "";
    }
    
    private void FilterByCategory(string? category)
    {
        selectedCategory = category;

        showCategoryDropdown = false; // Close dropdown after selection
    }

    private void FilterMyTickets(bool myTicketsOnly)
    {
        showMyTickets = myTicketsOnly;
        // You would implement logic here to filter to only your tickets
        // For example, you might filter by current user ID
    }
    
    private void ToggleCategoryDropdown()
    {
        showCategoryDropdown = !showCategoryDropdown;
    }
    
    // Close dropdown when clicking outside
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("window.addEventListener", "click", DotNetObjectReference.Create(this), "CloseDropdownOnClickOutside");
        }
    }
    
    [JSInvokable]
    public void CloseDropdownOnClickOutside()
    {
        if (showCategoryDropdown)
        {
            showCategoryDropdown = false;
            StateHasChanged();
        }
    }
    
    private IEnumerable<string> GetUniqueCategories()
    {
        return tickets?.Select(t => t.Category).Where(c => c != null).Distinct().Cast<string>() ?? Array.Empty<string>();
    }

    private async Task NavigateToTicket(int id)
    {
        await JSRuntime.InvokeVoidAsync("window.location.href", $"/tickets/{id}");
    }

    // Updated filtering and sorting logic
    private IEnumerable<TicketComp.TicketContainer> FilteredAndSortedTickets 
    { 
        get
        {
            if (tickets == null)
                return Array.Empty<TicketComp.TicketContainer>();
                
            var filtered = tickets.AsEnumerable();
            
            // Filter by "My" tickets if selected
            if (showMyTickets)
            {
                // Replace this with your actual logic for determining "my" tickets
                // For example: filtered = filtered.Where(t => t.AssignedTo == currentUserId);
                filtered = filtered.Take(3); // Just for demonstration
            }
            
            // Apply category filter if selected
            if (!string.IsNullOrEmpty(selectedCategory))
            {
                filtered = filtered.Where(t => t.Category == selectedCategory);
            }
            
            // Apply search term if provided
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(t => 
                    (t.Header != null && t.Header.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) || 
                    (t.Details != null && t.Details.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) || 
                    (t.Category != null && t.Category.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                );
            }
            
            // Order by date, newest first
            return filtered.OrderByDescending(t => t.Date);
        }
    }

    private int GetMyTicketsCount()
    {
        if (tickets == null)
            return 0;
            
        // Replace this with your actual logic for determining "my" tickets
        // For demo purposes, using the same logic as in FilteredAndSortedTickets
        return tickets.Take(3).Count();
    }

    private int GetAllTicketsCount()
    {
        return tickets?.Length ?? 0;
    }

    private void ClearCategoryFilter()
    {
        selectedCategory = null;
    }
}